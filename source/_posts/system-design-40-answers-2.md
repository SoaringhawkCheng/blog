---
title: 「面试系统设计题」学习笔记 （下）
catalog: true
date: 2022-04-15 17:18:58
subtitle:
header-img:
tags:
- architecture
categories:
- 工程
---

> 参考资料链接：[高并发系统设计40问](https://zq99299.github.io/note-architect/hc/) [系统设计题精选](https://soulmachine.gitbooks.io/system-design/content/cn/)
> 
> 书籍豆瓣链接： 
> 
> 开始学习时间：
> 
> 预计完成时间：
> 
> 实际完成时间：

# 四、消息队列

## 4.1 如何处理大量写请求

异步处理、解耦合和削峰填谷 是消息队列在秒杀系统设计中起到的主要作用


## 4.2处理消息丢失

### 4.2.1 消息生产阶段

使用重传，重试次数2-3次，但仍然有丢失的风险

### 4.2.2 消息队列阶段

为减少磁盘的随机I/O，会将消息写入操作系统的Page Cache中，然后异步刷入磁盘，这样会造成未持久化宕机造成的消息丢失

redis集群有leader提供消息写入和消费，多个follower负责数据的备份，leader故障就从follower的ISR选主

如果需要确保消息不丢失，生产者需要设置`acks=all`，每一条消息必须得到所有Leader和ISR确认才会被认为发送成功

### 4.2.3 消费过程阶段

一定要等到消息接收和处理完成后才能更新消费进度，但是这也会造成消息重复的问题

## 4.3 如何保证消息只被消息一次

想要完全的避免消息重复的发生是很难做到的，只能保证在消息的生产和消费的过程是幂等的

### 4.3.1 消息不重复生产

给每一个生产者一个唯一的 ID，并且为生产的每一条消息赋予一个唯一 ID，消息队列的服务端会存储`<生产者 ID，最后一条消息ID>`的映射，丢失重复消息

### 4.3.2 消费端

通过版本号，发送消息查询版本号，消费后增加版本号，丢弃低版本号消息

## 4.4 如何降低消息队列系统消息的延迟

### 4.4.1 监控消息延迟

Kakfa 的一个专门的 topic 叫 `__consumer_offsets`，Kafka 安装包的 bin 目录下有个工具`kafka-consumer-groups.sh`，可以查看消息消费情况

### 4.4.2 优化消息延迟

#### 4.4.2.1 消费端

1. 提升consumer代码性能

2. 一个partition对应一个consumer，否则需要加锁。consumer创建一个线程池，一次拉取多条消息，分配给多个线程处理

3. 客户端拉取消息，采用递增步长，10ms拉不到，下次20ms，20ms拉不到下次100ms

#### 4.4.2.2 消息队列

1. 数据库写入qps只能到千级别，消息存储使用本地磁盘而不是数据库，page cache可以提升读取速度，因为消息读取是顺序的

2. 零拷贝，sendfile直接将数据从内核缓冲区拷贝到socket缓冲区，不经过用户缓冲区

## 4.5 

# 五、分布式服务

# 六、维护

# 七、实战篇
